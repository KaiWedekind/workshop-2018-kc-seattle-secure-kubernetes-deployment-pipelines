# Protecting against vulnerable images

Harbor ships with a vulnerability scanner called Clair, which allows us to check our image for published vulnerabilities ([CVEs](https://cve.mitre.org/about/faqs.html)) before deploying, and to make decisions based on the findings.

> Ensure you have completed section 01 if you haven't already

## Configure Harbor to use Clair

1. Turn on image scanning for the default library project.
    1. Open the Harbor UI.
    2. Select the `library` project, and then click the `Configuration` tab.
    3. Select `Prevent vulnerable images from running` and set the threshold to high. This will prevent vulnerable images with one or more `high` vulnerability CVEs from getting pulled from this registry.
    4. Set the option to scan on push.

2. If left alone, the registry will eventually pull the vulnerability database from the internet, however depending on bandwidth this can be a lengthy process. For ease of access, run the following command to load the Clair database from your local machine into minikube. Replace `<harbor-database>` with the name of the container on the Minikube VM which you can find with `docker ps` while on the VM (it probably starts with k8s_database_harbor-harbor-database):

    ```bash
    scp -r -i $(minikube ssh-key) ./clair-db/* docker@$(minikube ip):/home/docker/
    minikube ssh
    docker exec -i <harbor-database> psql -U postgres < clear.sql
    docker exec -i <harbor-database> psql -U postgres < vulnerability.sql
    exit
    ```

3. Now build the image to be scanned. Clone the demo-API project onto your local machine and check out the `kubecon` branch.

    ```bash
    git clone https://github.com/lukebond/demo-api.git
    cd demo-api
    git checkout kubecon
    ```

4. Build the demo-api image and push it into your local Harbor registry.

    ```bash
    docker build . -t $MINIKUBE_IP:30003/library/demo-api:vulnerable
    docker push $MINIKUBE_IP:30003/library/demo-api:vulnerable
    ```

5. In the Harbor UI, enter the library project and view the demo-api image. The vulnerability rating should be showing as `HIGH`, indicating that there is one or more strong vulnerabilities in the image.

6. Move your terminal back out of the demo-api project.

    ```bash
    cd ..
    ```

## Deploy a vulnerable image

1. Edit the setup/demo-api.yaml file in this repo by replacing `<Minikube_IP>` with the minikube IP you found in a previous step. Enter the workshop repo and attempt to deploy the image from the registry into your minikube cluster.

    ```bash
    kubectl edit setup/demo-api.yaml
    kubectl apply -f setup/demo-api.yaml
    ```

2. Check if it has deployed with

    ```bash
    kubectl get pods
    ```

    If you have configured harbor correctly, you will notice that the pod has an `ErrImagePull` or `ImagePullBackOff` error. If you get an `InvalidImageName` error, check that you replaced `<Minikube_IP>` everywhere that it appears in setup/demo-api.yaml and try to deploy again.

3. Investigate the reason for the pull failure.

    ```bash
    kubectl describe pod <pod name>
    ```

    The event log should show that the image was denied based on its high vulnerability.

    ```text
    Failed to pull image "192.168.99.100:30003/library/demo-api:vulnerable": rpc error: code = Unknown desc = Error response from daemon: unknown: The severity of vulnerability of the image: "high" is equal or higher than the threshold in project setting: "high".
    ```

    If you see an error about SSL certificates, double check that your `minikube start` command had the right insecure registry url.

## Fix and deploy secure images

To fix the image and get our app deployed, we need to update the Dockerfile with a secure base image.

1. In the Dockerfile, change the base image to `alpine:3.4`, then rebuild and push the demo-api image.

    ```bash
    cd demo-api
    vi Dockerfile
    docker build . -t $MINIKUBE_IP:30003/library/demo-api:secure
    docker push $MINIKUBE_IP:30003/library/demo-api:secure
    ```

2. Change the deployment yaml `demo-api.yaml` to reference your new secure image, with the secure tag and redeploy.

    ```bash
    cd ..
    vi setup/demo-api.yaml
    kubectl apply -f setup/demo-api.yaml
    ```

3. Check if the pod has come up. Due to port limitations in Minikube, if your pod throws a `CrashLoopBackOff` error, you can delete the service with `kubectl delete service/demo-api`, wait for the pod to come up and then reapply the yaml above.

4. Get your Minikube IP using `minikube ip`. Go to your browser and enter your cluster IP with the port defined in the yaml, `http://<Minikube_IP>:30009/` you will see the demo api has been deployed successfully.
